<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="page-diary">
	<template>
		<style>
			:host {
				display: block;
			}

			aplie-meeting{
				width: 100%;
				height: 100%;
				margin: 5px;
				border: 1px solid red;
			}
			@media (min-width: 601px) {
			    #content{
			      padding: 48px 62px;
			    }
			    paper-material {
			      width: calc(98% - 46px);
			      margin-bottom: 32px;
			      padding-left: 30px;
			      padding-right: 30px;
			    }
			}

	    #formdiary{
		    width: 400px;
		    height:550px;
		  }
		  #formdiary>.col30{
		    display: inline-block;
		    width: 30%;
		  }
		  #formdiary>.col50{
		    display: inline-block;
		    width: 45%;
		  }
		  #formdiary>.col100{
		    width: 90%;
		  }
		  #formdiary>.dch{
		    float: right;
		  }


		</style>
		<paper-toolbar>
			<paper-icon-button icon="menu" on-click="toggleMenu"></paper-icon-button>
			<span class="title"> Agenda </span>
			<paper-icon-button icon="arrow-back" on-click="_moveWeek1"></paper-icon-button>
			<paper-icon-button icon="date-range"></paper-icon-button>
			<paper-icon-button icon="arrow-forward" on-click="_moveWeek"></paper-icon-button>
		</paper-toolbar>

		<div id="content">

			<my-diary  id="diarymeeting" dateini="{{showday}}" nday="{{nsday}}" on-evenexist="_showform" whours="{{ahours}}"> </my-diary>


			<!-- ventana emergente con el formulario -->
			<paper-dialog id="dialogo1" modal>
					<my-form-dyary-item  datain="{{formdatain}}" dataout="{{formdataout}}"></my-form-dyary-item>	
			</paper-dialog>
		</div>
	</template>

	<script>
	var myArray = new Array();
		(function () {
			Polymer({
				is: 'page-diary',
				properties: {
					nsday:{
						type:Number,
						value:5
					},
					showday: {
						type:String,
						value:function(){
							var f=new Date();
							return f.getFullYear()+"-"+this._addZeroOneCaracter(f.getMonth()+1)+"-"+this._addZeroOneCaracter(f.getDate());
						}
					},
					dataini:{
						type: Object,
						value: function(){ return {}}
					},
					ahours:{
						type:Array,
						value:function(){
							return  [{ 'hini':  "8:00",  "hfin" : "13:00" },
									{ 'hini':  "15:00",  "hfin" : "19:00" }]
							}
					},
					interval:{
						type:Number,
						value:30
					},
		            // datos del formulario modal
		            formdatain:{
		            	type:Object,
		            },
		            formdataout:{
		            	type:Object,
		            	observer:'_confirmForm'
		            },		            
				},
				_showform: function(e){
					console.log("llega"+e.detail.dtime)
					    datetime=new Date(e.detail.dtime);
					    tend=new Date(datetime.setMinutes(datetime.getMinutes()+parseInt(this.interval)));
						this.formdatain={
							'date': e.detail.dtime.split(" ")[0],
							'time_start': e.detail.dtime.split(" ")[1],
							'time_end':tend.getHours()+":"+tend.getMinutes(),
 				            'id_action': e.detail.id_action,
 				            'comment': e.detail.comment,
 				            'interval': this.interval, 				            
						}


						this.$.dialogo1.toggle();
				},
				_confirmForm: function(){
						data={'date_ini': this.formdataout.date+" "+this.formdataout.time_start+":00",
							  'date_end': this.formdataout.date+" "+this.formdataout.time_end+":00",
 				              'id_action': this.formdataout.id_action,
 				              'comment': this.formdataout.comment,
						}
						console.log("se ha cerrado el form");
						console.log(data)
			        this._insertNewData()

			        this._dataPaint(this.formdataout.date, this.formdataout.time_start,this.formdataout.time_end ,this.formdataout.comment);

			       console.log("datos confirmados"+JSON.stringify(myArray))

				},
				_insertNewData: function(data){
						myArray.push(data);
				},
				_dataPaint: function(date,tini,tfin,texto){
					pini=date+" "+tini
					meeting=this.$.diarymeeting;
					console.log("a pintar:"+pini+"/comentario"+this.comment)
					if(meeting.querySelector("div[dtime='"+pini+"']")){
						eparent=meeting.querySelector("div[dtime='"+pini+"']");
						elem=document.createElement('div');
						texto=document.createTextNode(texto);
						//añadido  style-scope my-month porque sino no acepta los estilos
						elem.setAttribute('class','cita style-scope aplie-meeting');

						var d1 = new Date(date+" "+tini+":00");
						var d2 = new Date(date+" "+tfin+":00");
						console.log(date+" "+tini+":00"+"--->"+d1+"-- ii "+this.interval )
						console.log(date+" "+tfin+":00"+"--->"+d2+"-- ii "+this.interval )
						//La diferencia se da en milisegundos así que debes dividir entre 1000
						var c = ((d2-d1)/60000);
						console.log("diferencia en minutos:"+c ) // resultado 5;



						dur=(c/this.interval)*21
						elem.setAttribute('style','width: '+(eparent.offsetWidth-20)+"px; height: "+dur+"px");
						elem.appendChild(texto);
						eparent.appendChild(elem);
					}

				},

				_addZeroOneCaracter:function(dmunber){
						return dmunber < 10 ? '0' + dmunber : '' + dmunber;
				}
			});
		})();
	</script>
</dom-module>
